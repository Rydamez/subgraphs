#################################################
# Enums
#################################################

enum ComptrollerStatus {
  COMMITTED
  DESTRUCTED
  FREE
  SIGNALLED
}

enum SharesChangeType {
  SharesBought
  SharesRedeemed
  SharesTransferredIn
  SharesTransferredOut
  FeeSharesPaid
  FeeSharesReceived
  FeeSharesBurned
  FeeSharesAllocationChanged
}

enum TradeType {
  ADD_TRACKED_ASSETS
  APPROVE_ASSETS
  CLAIM_REWARDS
  CLAIM_REWARDS_AND_REINVEST
  CLAIM_REWARDS_AND_SWAP
  LEND
  LEND_AND_STAKE
  REDEEM
  REMOVE_TRACKED_ASSETS
  STAKE
  TAKE_ORDER
  UNKNOWN
  UNSTAKE
  UNSTAKE_AND_REDEEM
}

#################################################
# Network
#################################################

type Network @entity {
  id: ID!
  currentRelease: Release
  vaults: Int!
  managers: Int!
  investors: Int!
  investments: Int!

  sharesTokenSymbol: String!
  migrationTimelock: Int!
  owner: String!
  nominatedOwner: String

  protocolFeeRate: BigDecimal!
  mlnBurned: BigDecimal!

  releases: [Release!]! @derivedFrom(field: "network")
}

type Release @entity {
  id: ID!
  current: Boolean!
  open: BigInt!
  close: BigInt
  isLive: Boolean!
  network: Network!
  vaults: [Vault!] @derivedFrom(field: "release")
}

#################################################
# Vault
#################################################

type Vault @entity {
  id: ID!
  name: String!
  comptroller: Comptroller!
  release: Release!
  inception: BigInt!

  creator: Account!
  owner: Account!
  nominatedOwner: Account
  assetManagers: [Account!]!
  migrator: Account

  freelyTransferableShares: Boolean!
  trackedAssets: [Asset!]!

  totalSupply: BigDecimal!
  investmentCount: Int!

  protocolFee: ProtocolFee
  protocolFeeSharesPaid: [ProtocolFeePaid!]! @derivedFrom(field: "vault")
  protocolFeeBurned: [ProtocolFeeBurned!]! @derivedFrom(field: "vault")

  comptrollers: [Comptroller!]! @derivedFrom(field: "vault")
  trades: [Trade!]! @derivedFrom(field: "vault")
  investments: [Investment!]! @derivedFrom(field: "vault")
  migrations: [Migration!]! @derivedFrom(field: "vault")
  reconfigurations: [Reconfiguration!]! @derivedFrom(field: "vault")
  sharesChanges: [SharesChange!]! @derivedFrom(field: "vault")
}

type Comptroller @entity {
  id: ID!
  vault: Vault
  creator: Account!
  release: Release!
  status: ComptrollerStatus!
  creation: BigInt!
  activation: BigInt!
  destruction: BigInt
  denomination: Asset!
  authUsers: [Account!]!
  autoProtocolFeeSharesBuyback: Boolean!
  gasRelayer: GasRelayer
  fees: [Fee!]! @derivedFrom(field: "comptroller")
  policies: [Policy!]! @derivedFrom(field: "comptroller")
}

type Migration @entity {
  id: ID!
  vault: Vault!
  comptroller: Comptroller!
  prevRelease: Release!
  nextRelease: Release!
  executableTimestamp: BigInt!
  executed: Boolean!
  executedTimestamp: BigInt
  cancelled: Boolean!
  cancelledTimestamp: BigInt
}

type Reconfiguration @entity {
  id: ID!
  vault: Vault!
  comptroller: Comptroller!
  release: Release!
  executableTimestamp: BigInt!
  executed: Boolean!
  executedTimestamp: BigInt
  cancelled: Boolean!
  cancelledTimestamp: BigInt
}

#################################################
# Account
#################################################

type Account @entity {
  id: ID!

  isOwner: Boolean!
  isAuthUser: Boolean!
  isAssetManager: Boolean!
  isInvestor: Boolean!

  ownerSince: BigInt!
  authUserSince: BigInt!
  assetManagerSince: BigInt!
  investorSince: BigInt!

  ownerships: [Vault!]! @derivedFrom(field: "owner")
  authUserships: [Comptroller!]! @derivedFrom(field: "authUsers")
  assetManagements: [Vault!]! @derivedFrom(field: "assetManagers")
  investments: [Investment!]! @derivedFrom(field: "investor")
  sharesChanges: [SharesChange!]! @derivedFrom(field: "investor")
}

#################################################
# Investment / Shares Changes
#################################################

type Investment @entity {
  id: ID!
  since: BigInt!
  vault: Vault!
  investor: Account!
  shares: BigDecimal!

  sharesChanges: [SharesChange!]! @derivedFrom(field: "investment")
}

interface SharesChange {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  investor: Account!
  investment: Investment!
  timestamp: BigInt!
  shares: BigDecimal!
}

type SharesBoughtEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  depositAssetAmount: AssetAmount!
  sharesIssued: BigDecimal!
  timestamp: BigInt!
}

type SharesTransferredOutEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  timestamp: BigInt!
}

type SharesTransferredInEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  timestamp: BigInt!
}

type SharesRedeemedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  payoutAssetAmounts: [AssetAmount!]!
  timestamp: BigInt!
}

type FeeSharesPaidEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  timestamp: BigInt!
}

type FeeSharesReceivedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  timestamp: BigInt!
}

type FeeSharesBurnedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  timestamp: BigInt!
}

type FeeSharesAllocationChangedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  investor: Account!
  investment: Investment!
  shares: BigDecimal!
  timestamp: BigInt!
}

#################################################
# Fees
#################################################

interface Fee {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
}

type EntranceRateBurnFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
  rate: BigDecimal!
  lastSettled: BigInt!
}

type EntranceRateDirectFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
  rate: BigDecimal!
  lastSettled: BigInt!
  recipient: Account
}

type ExitRateBurnFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
  inKindRate: BigDecimal!
  specificAssetsRate: BigDecimal!
  lastSettled: BigInt!
}

type ExitRateDirectFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
  inKindRate: BigDecimal!
  specificAssetsRate: BigDecimal!
  lastSettled: BigInt!
  recipient: Account
}

type ManagementFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
  scaledPerSecondRate: BigInt!
  lastSettled: BigInt!
  activatedForMigratedFundAt: BigInt!
  recipient: Account
}

type PerformanceFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  settings: String!
  rate: BigDecimal!
  period: BigInt!
  activatedAt: BigInt!
  lastPaid: BigInt!
  highWaterMark: BigDecimal!
  lastSharePrice: BigDecimal!
  aggregateValueDue: BigDecimal!
  sharesOutstanding: BigDecimal!
  recipient: Account
}

type UnknownFee implements Fee @entity {
  id: ID!
  fee: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  lastSettled: BigInt!
  settings: String!
}

#################################################
# Policies
#################################################

interface Policy {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
}

type AdapterBlacklistPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  adapters: [String!]!
}

type AdapterWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  adapters: [String!]!
}

type AllowedAdapterIncomingAssetsPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  assets: [String!]!
}

type AllowedDepositRecipientsPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  accounts: [String!]!
}

type AssetBlacklistPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  assets: [String!]!
}

type AssetWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  assets: [String!]!
}

type BuySharesCallerWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  callers: [String!]!
  updatedAt: BigInt!
}

type GuaranteedRedemptionPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  startTimestamp: BigInt!
  duration: BigInt!
}

type InvestorWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  investors: [String!]!
  updatedAt: BigInt!
}

type MaxConcentrationPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  maxConcentration: BigDecimal!
}

type MinMaxInvestmentPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
  minInvestmentAmount: BigDecimal!
  maxInvestmentAmount: BigDecimal!
  updatedAt: BigInt!
}

type UnknownPolicy implements Policy @entity {
  id: ID!
  policy: String!
  comptroller: Comptroller!
  createdAt: BigInt!
  enabled: Boolean!
  settings: String!
}

#################################################
# Trading
#################################################

type Trade @entity {
  id: ID!
  vault: Vault!
  adapter: String!
  type: TradeType!
  incomingAssets: [Asset!]!
  outgoingAssets: [Asset!]!
  incomingAssetAmounts: [AssetAmount!]!
  outgoingAssetAmounts: [AssetAmount!]!
  timestamp: BigInt!
}

#################################################
# Gas Relayer
#################################################

type GasRelayer @entity {
  id: ID!
  comptroller: Comptroller!
  balance: BigDecimal!

  deposited: [GasRelayerDeposited!]! @derivedFrom(field: "gasRelayer")
  withdrawn: [GasRelayerWithdrawn!]! @derivedFrom(field: "gasRelayer")
  transactions: [GasRelayerTransaction!]! @derivedFrom(field: "gasRelayer")
}

type GasRelayerDeposited @entity {
  id: ID!
  gasRelayer: GasRelayer!
  amount: BigDecimal!
}

type GasRelayerWithdrawn @entity {
  id: ID!
  gasRelayer: GasRelayer!
  amount: BigDecimal!
}

type GasRelayerTransaction @entity {
  id: ID!
  gasRelayer: GasRelayer!
  authorizer: String!
  invokedSelector: String!
  successful: Boolean!
}

#################################################
# Protocol Fees
#################################################

type ProtocolFee @entity {
  id: ID!
  vault: Vault!
  feeTracker: String!
  rate: BigDecimal!
  lastPaid: BigInt!
}

type ProtocolFeePaid @entity {
  id: ID!
  vault: Vault!
  shares: BigDecimal!
}

type ProtocolFeeBurned @entity {
  id: ID!
  vault: Vault!
  sharesBoughtBack: BigDecimal!
  mlnBurned: BigDecimal!
}

#################################################
# Assets and prices
#################################################

type Asset @entity {
  id: ID!
  name: String!
  symbol: String!
  decimals: Int!

  # Vault references
  trackingVaults: [Vault!]! @derivedFrom(field: "trackedAssets")
}

type AssetAmount @entity {
  id: ID!
  asset: Asset!
  amount: BigDecimal!
  valueAud: BigDecimal!
  valueBtc: BigDecimal!
  valueChf: BigDecimal!
  valueEth: BigDecimal!
  valueEur: BigDecimal!
  valueGbp: BigDecimal!
  valueJpy: BigDecimal!
  valueUsd: BigDecimal!
  timestamp: BigInt!
}

type AssetPrice @entity {
  id: ID!
  timestamp: BigInt!
  asset: Asset!
  price: BigDecimal!
}

type CurrencyPrice @entity {
  id: ID!
  timestamp: BigInt!
  ethAud: BigDecimal!
  ethBtc: BigDecimal!
  ethChf: BigDecimal!
  ethEur: BigDecimal!
  ethGbp: BigDecimal!
  ethJpy: BigDecimal!
  ethUsd: BigDecimal!
}

#################################################
# External Positions
#################################################

interface ExternalPosition {
  id: ID!
  vault: Vault!
  type: Int!
  active: Boolean!

  changes: [ExternalPositionChange!]! @derivedFrom(field: "externalPosition")
}

interface ExternalPositionChange {
  id: ID!
  externalPosition: ExternalPosition!
}

type CompoundDebtPosition implements ExternalPosition @entity {
  id: ID!
  vault: Vault!
  type: Int!
  active: Boolean!

  collateralAmounts: [AssetAmount!]!
  borrowedAmounts: [AssetAmount!]!

  changes: [ExternalPositionChange!]! @derivedFrom(field: "externalPosition")
}

enum CompoundDebtPositionChangeType {
  AssetBorrowed
  BorrowedAssetRepaid
  CollateralAssetAdded
  CollateralAssetRemoved
}

type CompoundDebtPositionChange @entity {
  id: ID!
  externalPosition: ExternalPosition!
  changeType: CompoundDebtPositionChangeType!
  assetAmount: AssetAmount!
}
