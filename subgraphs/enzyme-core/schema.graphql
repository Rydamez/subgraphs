#################################################
# Enums
#################################################

enum ComptrollerStatus {
  COMMITTED
  DESTRUCTED
  FREE
  SIGNALLED
}

enum SharesChangeType {
  SharesBought
  SharesRedeemed
  SharesTransferredIn
  SharesTransferredOut
  FeeSharesPaid
  FeeSharesReceived
  FeeSharesBurned
  FeeSharesAllocationChanged
}

enum TradeType {
  ADD_TRACKED_ASSETS
  APPROVE_ASSETS
  CLAIM_REWARDS
  CLAIM_REWARDS_AND_REINVEST
  CLAIM_REWARDS_AND_SWAP
  LEND
  LEND_AND_STAKE
  REDEEM
  REMOVE_TRACKED_ASSETS
  STAKE
  TAKE_ORDER
  UNKNOWN
  UNSTAKE
  UNSTAKE_AND_REDEEM
}

#################################################
# Network
#################################################

type Network @entity {
  id: ID!
  currentRelease: Release
  vaults: Int!
  managers: Int!
  depositors: Int!
  deposits: Int!

  sharesTokenSymbol: String!
  migrationTimelock: Int!
  owner: Bytes!
  nominatedOwner: Bytes

  protocolFeeRate: BigDecimal!
  mlnBurned: BigDecimal!

  releases: [Release!]! @derivedFrom(field: "network")
}

type Release @entity {
  id: ID!
  current: Boolean!
  open: Int!
  close: Int
  isLive: Boolean!

  dustToleranceInWeth: BigDecimal

  network: Network!
  vaults: [Vault!] @derivedFrom(field: "release")
}

#################################################
# Vault
#################################################

type Vault @entity {
  id: ID!
  name: String!
  comptroller: Comptroller!
  release: Release!
  inception: Int!

  creator: Account!
  owner: Account!
  nominatedOwner: Account
  assetManagers: [Account!]!
  migrator: Account

  freelyTransferableShares: Boolean!
  trackedAssets: [Asset!]!

  totalSupply: BigDecimal!
  depositCount: Int!

  protocolFee: ProtocolFee
  protocolFeeSharesPaid: [ProtocolFeePaid!]! @derivedFrom(field: "vault")
  protocolFeeBurned: [ProtocolFeeBurned!]! @derivedFrom(field: "vault")

  comptrollers: [Comptroller!]! @derivedFrom(field: "vault")
  trades: [Trade!]! @derivedFrom(field: "vault")
  deposits: [Deposit!]! @derivedFrom(field: "vault")
  migrations: [Migration!]! @derivedFrom(field: "vault")
  reconfigurations: [Reconfiguration!]! @derivedFrom(field: "vault")
  sharesChanges: [SharesChange!]! @derivedFrom(field: "vault")
}

type Comptroller @entity {
  id: ID!
  vault: Vault
  creator: Account!
  release: Release!
  status: ComptrollerStatus!
  creation: Int!
  activation: Int!
  destruction: Int
  denomination: Asset!
  authUsers: [Account!]!
  autoProtocolFeeSharesBuyback: Boolean!
  gasRelayer: GasRelayer
  sharesActionTimelock: Int!
  fees: [Fee!]! @derivedFrom(field: "comptroller")
  policies: [Policy!]! @derivedFrom(field: "comptroller")
}

type Migration @entity {
  id: ID!
  vault: Vault!
  comptroller: Comptroller!
  prevRelease: Release!
  nextRelease: Release!
  executableTimestamp: Int!
  executed: Boolean!
  executedTimestamp: Int
  cancelled: Boolean!
  cancelledTimestamp: Int
}

type Reconfiguration @entity {
  id: ID!
  vault: Vault!
  comptroller: Comptroller!
  release: Release!
  executableTimestamp: Int!
  executed: Boolean!
  executedTimestamp: Int
  cancelled: Boolean!
  cancelledTimestamp: Int
}

#################################################
# Account
#################################################

type Account @entity {
  id: ID!

  isOwner: Boolean!
  isAuthUser: Boolean!
  isAssetManager: Boolean!
  isDepositor: Boolean!

  ownerSince: Int!
  authUserSince: Int!
  assetManagerSince: Int!
  depositorSince: Int!

  ownerships: [Vault!]! @derivedFrom(field: "owner")
  authUserships: [Comptroller!]! @derivedFrom(field: "authUsers")
  assetManagements: [Vault!]! @derivedFrom(field: "assetManagers")
  deposits: [Deposit!]! @derivedFrom(field: "depositor")
  sharesChanges: [SharesChange!]! @derivedFrom(field: "depositor")
}

#################################################
# Deposit / Shares Changes
#################################################

type Deposit @entity {
  id: ID!
  since: Int!
  vault: Vault!
  depositor: Account!
  shares: BigDecimal!

  sharesChanges: [SharesChange!]! @derivedFrom(field: "deposit")
}

interface SharesChange {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  depositor: Account!
  deposit: Deposit!
  timestamp: Int!
  shares: BigDecimal!
}

type SharesBoughtEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  depositAssetAmount: AssetAmount!
  sharesIssued: BigDecimal!
  timestamp: Int!
}

type SharesTransferredOutEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  timestamp: Int!
}

type SharesTransferredInEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  timestamp: Int!
}

type SharesRedeemedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  payoutAssetAmounts: [AssetAmount!]!
  timestamp: Int!
}

type FeeSharesPaidEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  timestamp: Int!
}

type FeeSharesReceivedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  timestamp: Int!
}

type FeeSharesBurnedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  timestamp: Int!
}

type FeeSharesAllocationChangedEvent implements SharesChange @entity {
  id: ID!
  vault: Vault!
  type: SharesChangeType!
  fee: Fee
  depositor: Account!
  deposit: Deposit!
  shares: BigDecimal!
  timestamp: Int!
}

#################################################
# Fees
#################################################

interface Fee {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
}

type EntranceRateBurnFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
  rate: BigDecimal!
  lastSettled: Int!
}

type EntranceRateDirectFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
  rate: BigDecimal!
  lastSettled: Int!
  recipient: Account
}

type ExitRateBurnFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
  inKindRate: BigDecimal!
  specificAssetsRate: BigDecimal!
  lastSettled: Int!
}

type ExitRateDirectFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
  inKindRate: BigDecimal!
  specificAssetsRate: BigDecimal!
  lastSettled: Int!
  recipient: Account
}

type ManagementFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
  scaledPerSecondRate: BigInt!
  lastSettled: Int!
  activatedForMigratedFundAt: Int!
  recipient: Account
}

type PerformanceFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  settings: String!
  rate: BigDecimal!
  period: Int!
  activatedAt: Int!
  lastPaid: Int!
  highWaterMark: BigDecimal!
  lastSharePrice: BigDecimal!
  aggregateValueDue: BigDecimal!
  sharesOutstanding: BigDecimal!
  recipient: Account
}

type UnknownFee implements Fee @entity {
  id: ID!
  fee: Bytes!
  type: FeeType!
  comptroller: Comptroller!
  createdAt: Int!
  lastSettled: Int!
  settings: String!
}

enum FeeType {
  EntranceRateBurn
  EntranceRateDirect
  ExitRateBurn
  ExitRateDirect
  Management
  Performance
  Unknown
}

#################################################
# Policies
#################################################

interface Policy {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
}

type AdapterBlacklistPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  adapters: [Bytes!]!
}

type AdapterWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  adapters: [Bytes!]!
}

type AllowedAdapterIncomingAssetsPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  addressLists: [AddressList!]!
}

type AllowedAdaptersPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  addressLists: [AddressList!]!
}

type AllowedAssetsForRedemptionPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  addressLists: [AddressList!]!
}

type AllowedDepositRecipientsPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  addressLists: [AddressList!]!
}

type AllowedExternalPositionTypesPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  externalPositionTypes: [Int!]!
}

type AllowedSharesTransferRecipientsPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  addressLists: [AddressList!]!
}

type AssetBlacklistPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  assets: [Bytes!]!
}

type AssetWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  assets: [Bytes!]!
}

type BuySharesCallerWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  callers: [Bytes!]!
  updatedAt: Int!
}

type CumulativeSlippageTolerancePolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  tolerance: BigDecimal!
  cumulativeSlippage: BigDecimal!
  lastSlippageTimestamp: Int!
}

type DepositorWhitelistPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  depositors: [Bytes!]!
  updatedAt: Int!
}

type GuaranteedRedemptionPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  startTimestamp: Int!
  duration: Int!
}

type MaxConcentrationPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  maxConcentration: BigDecimal!
}

type MinMaxDepositPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
  minDepositAmount: BigDecimal!
  maxDepositAmount: BigDecimal!
  updatedAt: Int!
}

type OnlyUntrackDustOrPricelessAssetsPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
}

type UnknownPolicy implements Policy @entity {
  id: ID!
  policy: Bytes!
  type: PolicyType!
  comptroller: Comptroller!
  createdAt: Int!
  enabled: Boolean!
  settings: String!
}

enum PolicyType {
  AdapterBlacklist
  AdapterWhitelist
  AllowedAdapterIncomingAssets
  AllowedAdapters
  AllowedAssetsForRedemption
  AllowedDepositRecipients
  AllowedExternalPositionTypes
  AllowedSharesTransferRecipients
  AssetBlacklist
  AssetWhitelist
  BuySharesCallerWhitelist
  CumulativeSlippageTolerance
  DepositorWhitelist
  GuaranteedRedemption
  MaxConcentration
  MinMaxDeposit
  OnlyUntrackDustOrPricelessAssets
  Unknown
}

#################################################
# Address Lists (for various policies)
#################################################

type AddressList @entity {
  id: ID!
  createdAt: Int!
  updatedAt: Int!
  creator: Bytes!
  owner: Bytes!
  updateType: AddressListUpdateType!
  items: [Bytes!]!
}

enum AddressListUpdateType {
  None
  AddOnly
  RemoveOnly
  AddAndRemove
}

#################################################
# Trading
#################################################

type Trade @entity {
  id: ID!
  vault: Vault!
  adapter: Bytes!
  type: TradeType!
  incomingAssets: [Asset!]!
  outgoingAssets: [Asset!]!
  incomingAssetAmounts: [AssetAmount!]!
  outgoingAssetAmounts: [AssetAmount!]!
  timestamp: Int!
}

#################################################
# Gas Relayer
#################################################

type GasRelayer @entity {
  id: ID!
  comptroller: Comptroller!
  balance: BigDecimal!

  deposited: [GasRelayerDeposited!]! @derivedFrom(field: "gasRelayer")
  withdrawn: [GasRelayerWithdrawn!]! @derivedFrom(field: "gasRelayer")
  transactions: [GasRelayerTransaction!]! @derivedFrom(field: "gasRelayer")
}

type GasRelayerDeposited @entity {
  id: ID!
  gasRelayer: GasRelayer!
  amount: BigDecimal!
}

type GasRelayerWithdrawn @entity {
  id: ID!
  gasRelayer: GasRelayer!
  amount: BigDecimal!
}

type GasRelayerTransaction @entity {
  id: ID!
  gasRelayer: GasRelayer!
  authorizer: Bytes!
  invokedSelector: String!
  successful: Boolean!
}

#################################################
# Protocol Fees
#################################################

type ProtocolFee @entity {
  id: ID!
  vault: Vault!
  feeTracker: Bytes!
  rate: BigDecimal!
  lastPaid: Int!
}

type ProtocolFeePaid @entity {
  id: ID!
  vault: Vault!
  shares: BigDecimal!
}

type ProtocolFeeBurned @entity {
  id: ID!
  vault: Vault!
  sharesBoughtBack: BigDecimal!
  mlnBurned: BigDecimal!
}

#################################################
# Assets and prices
#################################################

type Asset @entity {
  id: ID!
  name: String!
  symbol: String!
  decimals: Int!

  # Vault references
  trackingVaults: [Vault!]! @derivedFrom(field: "trackedAssets")
}

type AssetAmount @entity {
  id: ID!
  asset: Asset!
  amount: BigDecimal!
  denominationAsset: Asset!
  valueDenomination: BigDecimal!
  valueAud: BigDecimal!
  valueBtc: BigDecimal!
  valueChf: BigDecimal!
  valueEth: BigDecimal!
  valueEur: BigDecimal!
  valueGbp: BigDecimal!
  valueJpy: BigDecimal!
  valueUsd: BigDecimal!
  timestamp: Int!
}

type AssetPrice @entity {
  id: ID!
  timestamp: Int!
  asset: Asset!
  price: BigDecimal!
}

type CurrencyPrice @entity {
  id: ID!
  timestamp: Int!
  ethAud: BigDecimal!
  ethBtc: BigDecimal!
  ethChf: BigDecimal!
  ethEur: BigDecimal!
  ethGbp: BigDecimal!
  ethJpy: BigDecimal!
  ethUsd: BigDecimal!
}

#################################################
# External Positions
#################################################

interface ExternalPosition {
  id: ID!
  vault: Vault!
  type: Int!
  active: Boolean!

  changes: [ExternalPositionChange!]! @derivedFrom(field: "externalPosition")
}

interface ExternalPositionChange {
  id: ID!
  externalPosition: ExternalPosition!
}

type CompoundDebtPosition implements ExternalPosition @entity {
  id: ID!
  vault: Vault!
  type: Int!
  active: Boolean!

  collateralAmounts: [AssetAmount!]!
  borrowedAmounts: [AssetAmount!]!

  changes: [ExternalPositionChange!]! @derivedFrom(field: "externalPosition")
}

enum CompoundDebtPositionChangeType {
  AssetBorrowed
  BorrowedAssetRepaid
  CollateralAssetAdded
  CollateralAssetRemoved
}

type CompoundDebtPositionChange @entity {
  id: ID!
  externalPosition: ExternalPosition!
  changeType: CompoundDebtPositionChangeType!
  assetAmount: AssetAmount!
}

#################################################
# Metrics
#################################################

type MetricCounter @entity {
  id: ID!
  vaultMetricCounter: Int!
  depositMetricCounter: Int!
}

type VaultMetric @entity {
  id: ID!
  counter: Int!
  timestamp: Int!
  vault: Bytes!
  nav: BigDecimal!
  navReverted: Boolean!
  gav: BigDecimal!
  gavReverted: Boolean!
  totalSupply: BigDecimal!
  sharePrice: BigDecimal!
  denominationAsset: Bytes!
}

type DepositMetric @entity {
  id: ID!
  counter: Int!
  timestamp: Int!
  vault: Bytes!
  depositor: Bytes!
  balance: BigDecimal!
}
